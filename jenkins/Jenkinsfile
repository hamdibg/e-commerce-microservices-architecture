pipeline {
  agent any
  environment {
    REGISTRY = "ghcr.io/your-org" // Change "your-org" to your GitHub org or username
    IMAGE_TAG = "${env.BUILD_NUMBER}"
  }
  stages {
    stage('Build & Test') {
      steps {
        sh './mvnw clean verify'
      }
    }
    stage('Docker Build & Push') {
      steps {
        script {
          def services = ['api-gateway', 'users', 'products', 'order', 'payment', 'config-server', 'eureka-server']
          for (svc in services) {
            sh "docker build -f docker/${svc}.Dockerfile -t $REGISTRY/${svc}:$IMAGE_TAG ${svc}"
            withCredentials([usernamePassword(credentialsId: 'docker-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
              sh "echo $DOCKER_PASS | docker login ghcr.io -u $DOCKER_USER --password-stdin"
            }
            sh "docker push $REGISTRY/${svc}:$IMAGE_TAG"
          }
        }
      }
    }
    stage('Deploy to Kubernetes') {
      steps {
        withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
          sh 'helm upgrade --install shopify ./helm --set global.imageTag=$IMAGE_TAG --set global.imageRepository=$REGISTRY'
        }
      }
    }
  }
}
